(()=>{class e{constructor(e,t,i,s){this.scene=e,this.x=t,this.y=i,this.color=s,this.grid=e.grid,this.gridHeight=e.levelData.tiles.length,this.gridWidth=e.levelData.tiles[0].length,this.СandySpriteSize=e.СandySpriteSize,this.score=e.score,this.unsuccessfulSwipes=0}createCandySprite(){this.sprite=this.scene.add.sprite(0,0,this.color).setScale(this.СandySpriteSize),this.sprite.setDepth(3),this.isFrozen&&(this.ice=this.scene.add.sprite(this.x*this.scene.СandySize+this.scene.offsetX,this.y*this.scene.СandySize+this.scene.offsetY,"ice").setScale(this.СandySpriteSize+.1),this.ice.setDepth(4)),this.sprite.x=this.x*this.scene.СandySize+this.scene.offsetX,this.sprite.y=this.y*this.scene.СandySize+this.scene.offsetY}enableSwipe(){this.sprite.setInteractive(),this.sprite.on("pointerdown",(e=>{this.scene.activeCandy=this,this.isDragging=!0,this.startDragPos={x:e.worldX,y:e.worldY}})),this.scene.input.on("pointerup",(e=>{if(this.scene.activeCandy&&this.scene.activeCandy.isDragging){const t={x:e.worldX,y:e.worldY};this.scene.activeCandy.handleSwipe(t,this.scene),this.scene.activeCandy.isDragging=!1,this.scene.activeCandy=null}}))}handleSwipe(e,t){const i=e.x-this.startDragPos.x,s=e.y-this.startDragPos.y;let a=null;if(Math.abs(i)>50||Math.abs(s)>50){if(this.x<0||this.x>=this.gridWidth||this.y<0||this.y>=this.gridHeight)return void(C&&console.log("Свайп за пределами сетки"));Math.abs(i)>Math.abs(s)?i>0&&this.x<this.gridWidth-1?a=this.grid[this.y][this.x+1]:this.x>0&&(a=this.grid[this.y][this.x-1]):s>0&&this.y<this.gridHeight-1?a=this.grid[this.y+1][this.x]:this.y>0&&(a=this.grid[this.y-1][this.x])}if(a){if(a.isFrozen)return void(C&&console.log("Замороженная конфета"));t.tweens.add({targets:this.sprite,x:a.x*this.scene.СandySize+this.scene.offsetX,y:a.y*this.scene.СandySize+this.scene.offsetY,duration:100,ease:"Sine.easeInOut",onComplete:()=>{if([this.grid[this.y][this.x],this.grid[a.y][a.x]]=[this.grid[a.y][a.x],this.grid[this.y][this.x]],[this.x,this.y,a.x,a.y]=[a.x,a.y,this.x,this.y],void 0!==this.hasExploded)return this.explodeBomb(),void Y(t,"minus");if(void 0!==a.hasExploded)return a.explodeBomb(),void Y(t,"minus");if(void 0!==this.hasLightning)return this.explodeCandy(a.color),void Y(t,"minus");if(void 0!==a.hasLightning)return a.explodeCandy(this.color),void Y(t,"minus");if(void 0!==this.rocketType)return void(void 0!==a.rocketType?(this.explodeCrossRocket(),a.explodeCrossRocket(),Y(t,"minus")):(this.explodeRocket(),Y(t,"minus")));if(void 0!==a.rocketType)return void(null==this.rocketType&&(a.explodeRocket(),Y(t,"minus")));let e=f(this.scene);0===e.length?([this.grid[this.y][this.x],this.grid[a.y][a.x]]=[this.grid[a.y][a.x],this.grid[this.y][this.x]],[this.x,this.y,a.x,a.y]=[a.x,a.y,this.x,this.y],t.tweens.add({targets:this.sprite,x:this.x*this.scene.СandySize+this.scene.offsetX,y:this.y*this.scene.СandySize+this.scene.offsetY,duration:80,delay:120,ease:"Sine.easeInOut"}),t.tweens.add({targets:a.sprite,x:a.x*this.scene.СandySize+this.scene.offsetX,y:a.y*this.scene.СandySize+this.scene.offsetY,duration:80,delay:120,ease:"Sine.easeInOut"}),this.unsuccessfulSwipes++,this.unsuccessfulSwipes>=5&&(!function(e){let t=function(e){const t=e.grid,i=e.levelData.tiles.length,s=e.levelData.tiles[0].length;for(let a=0;a<i;a++)for(let i=0;i<s;i++){const s=T(e,i,a);if(s){C&&console.log(`Hint found at (${i}, ${a})`);const{swipedCandyX:e,swipedCandyY:o}=s;return t[o][e]}}C&&console.log("No hint found");return null}(e);console.log(t),t&&e.tweens.add({targets:t.sprite,yoyo:!0,scale:.8,duration:300,repeat:3,ease:"Sine.easeInOut"})}(t),this.unsuccessfulSwipes=0)):(Y(t,"minus"),function(e){const t=1,i=3;e.totalSteps=e.totalSteps+1,null==e.randomSteps&&(e.randomSteps=Math.floor(Math.random()*(i-t+1))+t);if(e.totalSteps===e.randomSteps&&(console.log(e.randomSteps),"box"===e.instantGift||"mobi"===e.instantGift)){e.giftModal.showModal();var s={userId:e.userId};a=s,fetch("/api/"+localStorage.getItem("locale")+"/games/prize",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+localStorage.getItem("token"),Accept:"application/json"},body:JSON.stringify(a)}).then((e=>e.json())).then((e=>{})).catch((e=>{console.error("Ошибка при отправке данных:",e)})),e.randomSteps=0}var a}(t),I(e,t)),this.isDragging=!1,this.startDragPos=null}}),t.tweens.add({targets:a.sprite,x:this.x*this.scene.СandySize+this.scene.offsetX,y:this.y*this.scene.СandySize+this.scene.offsetY,duration:100,ease:"Sine.easeInOut"})}}}class t extends e{constructor(e,t,i){super(e,t,i,"bomb"),this.hasExploded=!1,this.createCandySprite()}createCandySprite(){super.createCandySprite(),this.sprite.setTexture("bomb"),this.sprite.setScale(.1),this.scene.tweens.add({targets:this.sprite,scaleX:this.scene.СandySpriteSize,scaleY:this.scene.СandySpriteSize,ease:"Back.easeOut",duration:500,delay:300})}explodeBomb(){if(this.hasExploded)return;this.hasExploded=!0;let e=this.x,i=this.y;this.scene.score+=150;for(let s=e-1;s<=e+1;s++){for(let e=i-1;e<=i+1;e++)if(s>=0&&s<this.gridWidth&&e>=0&&e<this.gridHeight&&this.grid[e][s]){if(this.grid[e][s]instanceof u)return void y(s,e,this.scene.levelData,this.scene.grid);this.scene.time.delayedCall(30*s,(()=>{let t=this.scene.add.sprite(s*this.scene.СandySize+this.scene.offsetX,e*this.scene.СandySize+this.scene.offsetY,"explosion2").setScale(this.scene.explosionSpriteSize);t.setDepth(10),t.play("explode2"),t.on("animationcomplete",(()=>{t.destroy()}))})),l(this.grid[e][s].sprite,(()=>{this.scene.score+=15})),this.grid[e][s]instanceof t?this.grid[e][s].explodeBomb():this.grid[e][s]instanceof N?this.grid[e][s].explodeRocket():E[this.grid[e][s].color]&&E[this.grid[e][s].color].collected<E[this.grid[e][s].color].required&&E[this.grid[e][s].color].collected++,null!==this.grid[e][s]&&"color"in this.grid[e][s]&&"candy5"===this.grid[e][s].color&&Y(this.scene,"plus"),this.grid[e][s]=null}S(this.scene),R(this.scene)}let s=this.scene.add.sprite(this.sprite.x,this.sprite.y,"explosion1").setScale(this.scene.explosionSpriteSize);s.setDepth(10),s.play("explode"),s.on("animationcomplete",(()=>{s.destroy(),n(this.scene)}))}}class i extends Phaser.GameObjects.Container{constructor(e,t,i,s,a){super(e,t,i),this.scene=e,this.x=t,this.y=i,this.text=s,this.callback=a,this.background=this.scene.add.graphics(),this.background.fillStyle(15346822,1),this.background.fillRoundedRect(-276,-54,552,108,50),this.add(this.background),this.textObject=this.scene.add.text(0,0,s,{fontSize:"40px",fill:"#fff",fontFamily:"AVENGEANCE"}),this.textObject.setOrigin(.5,.5),this.textObject.setShadow(2,2,"#9D1555",2,!0,!0),this.add(this.textObject),this.setInteractive(new Phaser.Geom.Rectangle(-276,-54,552,108),Phaser.Geom.Rectangle.Contains),this.on("pointerdown",this.onPointerDown,this),this.on("pointerup",this.onPointerUp,this),this.scene.add.existing(this)}onPointerDown(){this.background.clear(),this.background.fillStyle(12264299,1),this.background.fillRoundedRect(-276,-54,552,108,50)}onPointerUp(){this.background.clear(),this.background.fillStyle(15346822,1),this.background.fillRoundedRect(-276,-54,552,108,50),this.callback()}}class s extends i{constructor(e,t,i,s,a){super(e,t,i),this.callback=a,this.background.clear(),this.background.lineStyle(8,16777215,1),this.background.strokeRoundedRect(-276,-54,552,108,50),this.add(this.background),this.textObject=this.scene.add.text(0,0,s,{fontSize:"40px",fill:"#fff",fontFamily:"AVENGEANCE"}),this.textObject.setOrigin(.5,.5),this.add(this.textObject),this.setInteractive(new Phaser.Geom.Rectangle(-276,-54,552,108),Phaser.Geom.Rectangle.Contains),this.on("pointerdown",this.onPointerDown,this),this.on("pointerup",this.onPointerUp,this),this.scene.add.existing(this)}onPointerDown(){this.background.clear(),this.background.fillStyle(16777215,.2),this.background.fillRoundedRect(-276,-54,552,108,50),this.background.lineStyle(8,16777215,1),this.background.strokeRoundedRect(-276,-54,552,108,50)}onPointerUp(){this.background.clear(),this.background.lineStyle(8,16777215,1),this.background.strokeRoundedRect(-276,-54,552,108,50),this.callback()}}function a(e,t,i,s){return!!(t>1&&e[i][t-1]&&e[i][t-1].color===s&&e[i][t-2]&&e[i][t-2].color===s)||!!(i>1&&e[i-1][t]&&e[i-1][t].color===s&&e[i-2][t]&&e[i-2][t].color===s)}function o(t){const i=t.levelData.tiles.length,s=t.levelData.tiles[0].length;for(let o=0;o<s;o++)for(let s=0;s<i;s++)if(null===t.grid[s][o]&&t.levelData.tiles[s][o]>0){let i,n,l=100+40*s;do{i=h(t.levelData,t.levelNumber),n=a(t.grid,o,s,i)}while(n);const r=new e(t,o,s,i);r.createCandySprite(),r.enableSwipe(),t.grid[s][o]=r,v++,r.sprite.y=-t.СandySize+t.offsetY,t.tweens.add({targets:r.sprite,y:s*t.СandySize+t.offsetY,duration:l,ease:"Sine.easeOut",onStart:()=>{},onComplete:function(){v--,I(f(t),t)}})}}function n(e){const t=e.levelData.tiles.length,i=e.levelData.tiles[0].length;for(let s=0;s<i;s++)for(let i=t-1;i>=0;i--)if(null===e.grid[i][s]&&e.levelData.tiles[i][s]>0){let t=!1;for(let a=i-1;a>=0;a--)if(null!==e.grid[a][s]&&e.levelData.tiles[a][s]>0){let n=0;for(let t=a+1;t<=i;t++)null===e.grid[t][s]&&n++;let l=160+30*n;e.grid[i][s]=e.grid[a][s],e.grid[a][s]=null,e.grid[i][s].y=i,v++,e.tweens.add({targets:e.grid[i][s].sprite,y:i*e.СandySize+e.offsetY,duration:l,ease:"Sine.easeOut",onStart:()=>{null!==e.grid[i][s]&&"ice"in e.grid[i][s]&&e.tweens.add({targets:e.grid[i][s].ice,y:i*e.СandySize+e.offsetY,duration:l,ease:"Sine.easeOut"})},onComplete:()=>{v--,0===v&&o(e)}}),t=!0;break}if(!t){setTimeout((()=>{0===v&&o(e)}),300);break}}}function l(e,t){v++,e.scene.tweens.add({targets:e,alpha:0,scale:0,duration:260,ease:"Sine.easeIn",onComplete:()=>{e.destroy(),v--,t&&"function"==typeof t&&t()}})}function r(e,t,i,s,a,o,n){switch(o){case"Верхний":i-=n,a-=n;break;case"Нижний":a+=n;break;case"Левый":t-=n,s-=n;break;case"Правый":s+=n}e.add.rectangle(t,i,s-t,a-i,2763649).setOrigin(0,0)}function d(e,t,i,s,a){if(i>=2){const t=e[i-1],s=e[i-2];if(t&&s&&t.color===a&&s.color===a)return!0}if(s>=2){const e=t[s-1][i],o=t[s-2][i];if(e&&o&&e.color===a&&o.color===a)return!0}return!1}function h(e,t){let i=function(e,t,i,s){let a=0,o=0,n={};for(let e of i)for(let t of e)1===t&&a++;let l=Math.max(8-.1*(t-1),0),r=Object.keys(s);for(let t of r)n[t]=(a-l)/e.length+4,o+=n[t];e.forEach((t=>{r.includes(t)||(n[t]=(a-o-l)/(e.length-r.length))})),n.candy5=l;let d=[];for(let e in n)for(let t=0;t<n[e];t++)d.push(e);return d}(e.colors,e.levelNumber,e.tiles,e.targetCandies);return i[Math.floor(Math.random()*i.length)]}function c(e){return e.frozenCandys[Math.floor(Math.random()*e.frozenCandys.length)]}class g extends Phaser.GameObjects.Container{constructor(e,t,i,s){super(e,t,i),this.scene=e,this.targetCandies=s,this.candyUIWidth=170,this.screenWidth=e.sys.game.config.width,Object.keys(this.targetCandies).length>=3?length=3:length=Object.keys(this.targetCandies).length,this.uiOffsetX=(this.screenWidth-this.candyUIWidth*length)/2+this.candyUIWidth/1.3;const a={fontSize:"40px",fontFamily:"AVENGEANCE",fill:"#fff",align:"left"};let o=e.add.text(e.cameras.main.width/2,418,e.langdata.modal_target,{fontSize:"28px",fill:"#fff",fontStyle:"bold",fontFamily:"AVENGEANCE"});o.setDepth(102),o.setOrigin(.5,0),o.setShadow(1,1,"rgba(0,0,0,0.4)",2),this.add(o);let n=0;for(let e in this.targetCandies){if(n>=3)break;let t=this.scene.add.sprite(this.uiOffsetX-this.candyUIWidth/2,510,e);t.setDepth(102),t.setScale(1.1),this.add(t);let i=this.scene.add.text(t.x+40,t.y-30,`X${this.targetCandies[e]}`,a);i.setDepth(102),i.setShadow(2,2,"rgba(0,0,0,0.2)",2),this.add(i),this.targetCandies[e]={uiImage:t,uiText:i,required:this.targetCandies[e],collected:0},this.uiOffsetX+=this.candyUIWidth,n++}this.scene.add.existing(this)}updateCandyUI(e,t){this.targetCandies[e]&&(this.targetCandies[e].uiText.setText(`X${t}`),this.targetCandies[e].collected=t)}}class p extends Phaser.GameObjects.Container{constructor(e,t,i,s,a){super(e,t,i),this.scene=e,this.textCoinValue=s,this.coinWinValue=a;this.textCoin=e.add.text(0,0,this.textCoinValue,{fontSize:"28px",fill:"#fff",fontFamily:"Montserrat",wordWrap:{width:230,useAdvancedWrap:!0}}),this.textCoin.setOrigin(.5,0),this.textCoin.setShadow(1,1,"rgba(0,0,0,0.4)",0),this.coinWin=e.add.text(285,6,this.coinWinValue,{fontSize:"40px",fill:"#fff",fontFamily:"Montserrat",wordWrap:{width:230,useAdvancedWrap:!0}}),this.coinWin.setOrigin(.5,0),this.coinWin.setShadow(1,1,"rgba(0,0,0,0.4)",2),this.bgCoin=e.add.sprite(270,0,"icon_coin"),this.bgCoin.setOrigin(.5,0),this.add([this.bgCoin,this.textCoin,this.coinWin]),e.add.existing(this)}updateCoinDisplay(e,t){this.textCoin.setText(e),this.coinWin.setText(t)}}function f(e){const t=e.grid;let i=[];const s=t[0].length,a=t.length;C&&console.log("Поиск совпадений из четырех конфет"),function(e,t){const i=t.tiles.length,s=t.tiles[0].length;for(let t=0;t<i;t++)for(let i=0;i<s;i++)e[t][i]&&(e[t][i].usedInMatch=!1)}(t,e.levelData);for(let e=0;e<s;e++)for(let o=0;o<a;o++){let n=t[o][e];n&&(o+2<a&&e-1>=0&&e+1<s&&t[o+1][e]&&t[o+1][e].color===n.color&&t[o+2][e]&&t[o+2][e].color===n.color&&t[o][e-1]&&t[o][e-1].color===n.color&&t[o][e+1]&&t[o][e+1].color===n.color&&i.push({x:e,y:o,type:"bomb"}),o-2>=0&&e-1>=0&&e+1<s&&t[o-1][e]&&t[o-1][e].color===n.color&&t[o-2][e]&&t[o-2][e].color===n.color&&t[o][e-1]&&t[o][e-1].color===n.color&&t[o][e+1]&&t[o][e+1].color===n.color&&i.push({x:e,y:o,type:"bomb"}),e+2<s&&o-1>=0&&o+1<a&&t[o][e+1]&&t[o][e+1].color===n.color&&t[o][e+2]&&t[o][e+2].color===n.color&&t[o-1][e]&&t[o-1][e].color===n.color&&t[o+1][e]&&t[o+1][e].color===n.color&&i.push({x:e,y:o,type:"bomb"}),e-2>=0&&o-1>=0&&o+1<a&&t[o][e-1]&&t[o][e-1].color===n.color&&t[o][e-2]&&t[o][e-2].color===n.color&&t[o-1][e]&&t[o-1][e].color===n.color&&t[o+1][e]&&t[o+1][e].color===n.color&&i.push({x:e,y:o,type:"bomb"}))}for(let e=0;e<a;e++)for(let a=0;a<s-4;a++)m(t,a,e,5,"horizontal")&&i.push({x:a,y:e,type:"lightning",color:t[e][a].color});for(let e=0;e<s;e++)for(let s=0;s<a-4;s++)m(t,e,s,5,"vertical")&&i.push({x:e,y:s,type:"lightning",color:t[s][e].color});for(let e=0;e<a;e++)for(let a=0;a<=s-4;a++)m(t,a,e,4,"horizontal")&&(a+4>=s||null===t[e][a+4]||t[e][a+4].color!==t[e][a].color)&&i.push({x:a,y:e,type:"rocket",direction:"horizontal"});for(let e=0;e<s;e++)for(let s=0;s<=a-4;s++)m(t,e,s,4,"vertical")&&(s+4>=a||null===t[s+4][e]||t[s+4][e].color!==t[s][e].color)&&i.push({x:e,y:s,type:"rocket",direction:"vertical"});for(let e=0;e<a;e++)for(let a=0;a<s-2;a++){let s=t[e][a],o=t[e][a+1],n=t[e][a+2];s&&o&&n&&s.color===o.color&&s.color===n.color&&(i.push({x:a,y:e}),i.push({x:a+1,y:e}),i.push({x:a+2,y:e}))}for(let e=0;e<s;e++)for(let s=0;s<a-2;s++){let a=t[s][e],o=t[s+1][e],n=t[s+2][e];a&&o&&n&&a.color===o.color&&a.color===n.color&&(i.push({x:e,y:s}),i.push({x:e,y:s+1}),i.push({x:e,y:s+2}))}return i.length>0&&C&&console.log("Найдены совпадения для бомбы:",i),i.forEach((i=>{!function(e,t,i,s){[[-1,0],[1,0],[0,-1],[0,1]].forEach((a=>{let o=e+a[0],n=t+a[1];if(o>=0&&o<i.gridWidth&&n>=0&&n<i.gridHeight){let e=s[n][o];if(e&&e.isFrozen){e.isFrozen=!1;const t=i.frozenCandys.indexOf(e.sprite.texture.key);-1!==t&&(console.log(e.ice),e.sprite.setTexture("candy"+(t+1)),e.color="candy"+(t+1))}}}))}(i.x,i.y,e.levelData,t)})),i}function m(e,t,i,s,a){let o=!0;for(let n=0;n<s;n++){let s="horizontal"===a?t+n:t,l="vertical"===a?i+n:i;if(!e[l]||!e[l][s]||null===e[l][s]||e[l][s].usedInMatch){o=!1;break}}if(o){const n=e[i][t].color;for(let l=0;l<s;l++){let s="horizontal"===a?t+l:t;if(e["vertical"===a?i+l:i][s].color!==n){o=!1;break}}}if(o)for(let o=0;o<s;o++){let s="horizontal"===a?t+o:t;e["vertical"===a?i+o:i][s].usedInMatch=!0}return o}class u extends e{constructor(e,t,i,s){super(e,t,i,s),this.isFrozen=!0}createCandySprite(){super.createCandySprite();const e=h(this.scene.levelData);this.sprite.setTexture(e),C&&console.log("Создан спрайт заморозки: "+e)}handleSwipe(){this.isFrozen?C&&console.log("Замороженная конфета"):super.handleSwipe()}}function y(e,t,i,s){let a=s[t][e];if(a&&a instanceof u&&a.isFrozen){a.isFrozen=!1;const e=i.frozenCandys.indexOf(a.sprite.texture.key);-1!==e&&(a.sprite.setTexture("candy"+(e+1)),a.color="candy"+(e+1),a.ice.destroy())}}function x(e){let t={fontSize:"64px",fill:"#fff",fontFamily:"AVENGEANCE",padding:{right:4}},i={fontSize:"32px",fill:"#fff",fontFamily:"AVENGEANCE",padding:{right:4}};if(e.add.sprite(e.cameras.main.width/2,100,"header").setScale(1),e.scoreText=e.add.text(40,30,"0",t),e.scoreText_=e.add.text(40,95,e.langdata.score_text,i),e.movesText=e.add.text(600,30,e.levelData.movesLeft,t),e.scoreText_=e.add.text(580,95,e.langdata.moves_text,i),6===e.levelData.tiles[0].length);else if(7===e.levelData.tiles[0].length);else;!function(e){var t=P();if(t.targetCandies)for(let e in t.targetCandies)E[e]={required:t.targetCandies[e],collected:0};else{G({targetCandies:e.levelData.targetCandies});for(let t in e.levelData.targetCandies)E[t]={required:e.levelData.targetCandies[t],collected:0}}const i=80,s=i*Object.keys(E).length,a=e.sys.game.config.width;let o=(a-s)/2+i/2;for(let t in E){let s=e.add.sprite(o,64,t).setScale(1),a=e.add.text(o,s.y+50,`${E[t].required}`,{fontSize:"32px",fontFamily:"AVENGEANCE",fill:"#fff",align:"center"});a.setOrigin(.5,0),E[t].uiText=a,o+=i}}(e),function(e){"0"!=e.levelData.timeLeft&&(e.timeText=e.add.text(290,10,"Время: "+levelData.timeLeft,{fontSize:"32px",fill:"#000"}),e.timeEvent=e.time.addEvent({delay:1e3,callback:F,callbackScope:e,loop:!0}))}(e)}function S(e){for(let i in E){let s=E[i],a=s.required-s.collected;var t=P();if(t.targetCandies[i]=a,G({targetCandies:t.targetCandies}),a<=0){s.uiText.setText("0");continue}let o={value:s.uiText.animatedValue||s.required};e.tweens.add({targets:o,value:a,duration:500,ease:"Sine.easeInOut",onUpdate:function(e){const t=Math.round(e.getValue());s.uiText.setText(`${t}`)},onComplete:function(){s.uiText.animatedValue=a}})}}class b extends Phaser.Scene{constructor(e,t){super({}),this.levelNumber=e,this.grid=[],this.score=0,this.explosionSpriteSize=.3,this.offsetY=350,this.levelData,this.modal,this.loadingProgress=0,this.userId=t.userId,this.userCoins=t.userCoins,this.userEnergy=t.userEnergy,this.levelNumber=t.levelNumber,this.coinWin=t.coinWin,this.lang=localStorage.getItem("locale"),this.instantGift=t.instantGift,this.langdata,this.totalSteps=0}goToNextLevel(){V("finish"),V("score"),V("movesLeft"),V("targetCandies"),V("level"),this.scene.stop(),window.location.reload()}preload(){this.cache.json.exists("levelData")&&this.cache.json.remove("levelData"),this.load.json("lang",`lang/${this.lang}.json`),this.load.once("filecomplete-json-lang",(function(){this.langdata=this.cache.json.get("lang"),this.load.start()}),this),this.load.json("levelData",`levels/${this.levelNumber}.json`),this.load.once("filecomplete-json-levelData",(function(){this.levelData=this.cache.json.get("levelData"),this.load.start()}),this);for(let e=1;e<=6;e++)this.load.image("candy"+e,"img/candies/candy"+e+".png");for(let e=1;e<=9;e++)this.load.image("explosion"+e,"img/explosion_bomb/explosion"+e+".png");for(let e=1;e<=13;e++)this.load.image("explosions"+e,"img/explosion_candy/explosions"+e+".png");this.load.image("bomb","img/bomb/bomb_normal.png"),this.load.image("rocket","img/rocket/rocket_normal.png"),this.load.image("lightning","img/lightning/lightning_normal.png"),this.load.image("header","img/ui/header.png"),this.load.image("popup","img/ui/popup.png"),this.load.image("modal_end","img/ui/modal_end.png"),this.load.image("modal_err","img/ui/modal_err.png"),this.load.image("energy","img/ui/energy.png"),this.load.image("modal_gift_box","img/ui/modal_gift_box.png"),this.load.image("modal_gift_mobi","img/ui/modal_gift_mobi.png"),this.load.image("modal_hint_energy","img/ui/modal_hint_energy.png"),this.load.image("modal_hint_rocket","img/ui/modal_hint_rocket.png"),this.load.image("modal_hint_light","img/ui/modal_hint_light.png"),this.load.image("modal_hint_bomb","img/ui/modal_hint_bomb.png"),this.load.image("modal_err_energy","img/ui/modal_err_energy.png"),this.load.image("btnClose","img/ui/btnClose.png"),this.load.image("btn","img/ui/btn_normal.png"),this.load.image("coins_bg","img/ui/coins_bg.png"),this.load.image("icon_coin","img/ui/icon_coin.png"),this.load.image("energy_bg","img/ui/energy_bg.png"),this.load.image("ice","img/frozen/ice.png");let e=this.add.text(D.scale.width/2,D.scale.height/2,"0%",{fontSize:"64px",fill:"#FFFFFF",fontFamily:"AVENGEANCE"}).setOrigin(.5);this.loadingText=e,this.load.on("progress",(function(e){this.updateLoadingProgress(.5,e)}),this),this.load.on("complete",(function(){this.updateLoadingProgress(.99,1),this.createLevel()}),this),this.load.start()}createLevel(){var t=P();if(t.score){this.score=t.score,this.levelData.movesLeft=t.movesLeft;var i=Object.keys(t.targetCandies),s=Object.keys(this.levelData.targetCandies);i.length===s.length&&i.every((function(e){return s.includes(e)}))||(V("finish"),V("score"),V("movesLeft"),V("targetCandies"),V("level"),this.scene.stop(),_())}this.СandySize=(D.scale.width-80)/this.levelData.tiles[0].length,this.СandySpriteSize=this.СandySize/90,this.offsetX=this.СandySize/2+40,X(this),x(this),function(e){e.anims.create({key:"explode",frames:[{key:"explosion1"},{key:"explosion2"},{key:"explosion3"},{key:"explosion4"},{key:"explosion5"},{key:"explosion6"},{key:"explosion7"},{key:"explosion8"},{key:"explosion9"}],frameRate:"30",repeat:"0"}),e.anims.create({key:"explode2",frames:[{key:"explosions1"},{key:"explosions2"},{key:"explosions3"},{key:"explosions4"},{key:"explosions5"},{key:"explosions6"},{key:"explosions7"},{key:"explosions8"},{key:"explosions9"},{key:"explosions10"},{key:"explosions11"},{key:"explosions12"},{key:"explosions13"}],frameRate:"30",repeat:"0"})}(this),function(t,i){C&&console.log("Начало создания сетки");const s=t.grid,a=i.tiles.length,o=i.tiles[0].length,n=24,l=t.СandySize,g=t.offsetX-l/2,p=t.offsetY-l/2;i.tiles.forEach(((e,s)=>{e.forEach(((a,o)=>{1!==a&&2!==a||(0!==s&&0!==i.tiles[s-1][o]||(0===o?r(t,o*l+t.offsetX/2-2,p+s*l,g+(o+1)*l,p+s*l+n,"Верхний",n):0===i.tiles[s][o+1]||o===i.tiles[0].length-1?r(t,g+o*l,p+s*l,g+(o+1)*l+2.4,p+s*l+n,"Верхний",n):r(t,g+o*l,p+s*l,g+(o+1)*l,p+s*l+n,"Верхний",n)),s!==i.tiles.length-1&&0!==i.tiles[s+1][o]||(0===o?r(t,g+o*l-2.4,p+(s+1)*l,g+(o+1)*l,p+(s+1)*l,"Нижний",n):o===i.tiles[0].length-1?r(t,g+o*l,p+(s+1)*l,g+(o+1)*l+2.4,p+(s+1)*l,"Нижний",n):r(t,g+o*l,p+(s+1)*l,g+(o+1)*l,p+(s+1)*l,"Нижний",n)),0!==o&&0!==i.tiles[s][o-1]||r(t,g+o*l,p+s*l,g+o*l+n,p+(s+1)*l,"Левый",n),o!==e.length-1&&0!==i.tiles[s][o+1]||r(t,g+(o+1)*l,p+s*l,g+(o+1)*l,p+(s+1)*l,"Правый",n))}))})),function(e,t,i,s,a,o){let n=e.add.graphics();for(let e=0;e<t.length;e++)for(let l=0;l<t[e].length;l++)if(1===t[e][l]){let r=0===l||0===t[e][l-1],d=l===t[e].length-1||0===t[e][l+1],h=0===e||0===t[e-1][l],c=e===t.length-1||0===t[e+1][l];r&&h&&n.fillCircle(i+l*a,s+e*a,o),d&&h&&n.fillCircle(i+(l+1)*a,s+e*a,o),r&&c&&n.fillCircle(i+l*a,s+(e+1)*a,o),d&&c&&n.fillCircle(i+(l+1)*a,s+(e+1)*a,o)}}(t,t.levelData.tiles,g,p,l,n),i.tiles.forEach(((e,i)=>{e.forEach(((e,s)=>{if(1===e||2===e){let e=(s+i)%2==0?39644:6730718,a=7===o?2:7;t.add.rectangle(s*l+t.offsetX/2-a,t.offsetY-l/2+i*l,l,l,e).setOrigin(0,0)}}))}));for(let n=0;n<a;n++){const a=[];for(let l=0;l<o;l++){let o=i.tiles[n][l];if(1===o||2===o){let r,g,p;do{r=1===o?h(i):c(i),g=d(a,s,l,n,r)}while(g);p=2===o?new u(t,l,n,r):new e(t,l,n,r),p.createCandySprite(),p.enableSwipe(),a.push(p),C&&console.log(`Конфета создана в позиции (${l}, ${n}), цвет: ${r}, заморожена: ${2===o}`)}else a.push(null),C&&console.log(`Пустая ячейка в позиции (${l}, ${n})`)}s.push(a)}C&&console.log("Сетка создана")}(this,this.levelData),this.startModal=new O(this,this.langdata.level+this.levelNumber,!0,!0,!0,!0,!0,this.langdata.btn_start,"start",!1),this.startModal.setDepth(101),this.endModal=new O(this,this.langdata.end_title,!1,!0,!0,!1,!0,this.langdata.btn_end,"end",!0),this.endModal.setDepth(101),this.giftModal=new O(this,this.langdata.gift_title,!1,!1,!1,!1,!0,this.langdata.btn_end,"gift",!1),this.giftModal.setDepth(101),this.errorEnergyModal=new A(this,"modal_err_energy",this.langdata.err_energy_title,this.langdata.err_energy_text,this.langdata.err_energy_text,this.langdata.btn_check),this.errorEnergyModal.setDepth(101),0!=this.userEnergy?!0===t.finish?this.endModal.showModal():this.startModal.showModal():this.errorEnergyModal.showModal()}updateLoadingProgress(e,t){this.loadingProgress=e*t,this.loadingText.setText(parseInt(100*this.loadingProgress)+"%")}create(){}}class w extends e{constructor(e,t,i){super(e,t,i,"lightning"),this.hasLightning=!0,this.createCandySprite()}createCandySprite(){super.createCandySprite(),this.sprite.setTexture("lightning"),this.sprite.setScale(.1),this.scene.tweens.add({targets:this.sprite,scaleX:this.scene.СandySpriteSize,scaleY:this.scene.СandySpriteSize,ease:"Back.easeOut",duration:500,delay:300})}explodeCandy(e){this.scene.score+=200;for(let t=0;t<this.gridHeight;t++)for(let i=0;i<this.gridWidth;i++)this.grid[t][i]&&this.grid[t][i].color===e&&(this.scene.time.delayedCall(30*i,(()=>{let e=this.scene.add.sprite(i*this.scene.СandySize+this.scene.offsetX,t*this.scene.СandySize+this.scene.offsetY,"explosion2").setScale(this.scene.explosionSpriteSize);e.setDepth(10),e.play("explode2"),e.on("animationcomplete",(()=>{e.destroy()}))})),l(this.grid[t][i].sprite,(()=>{this.scene.score+=10,E[e]&&E[e].collected<E[e].required&&E[e].collected++,"candy5"===e&&Y(this.scene,"plus")})),this.grid[t][i]=null);l(this.grid[this.y][this.x].sprite,(()=>{})),this.grid[this.y][this.x]=null,S(this.scene),R(this.scene);let t=this.scene.add.sprite(this.sprite.x,this.sprite.y,"explosion1").setScale(this.scene.explosionSpriteSize);t.setDepth(10),t.play("explode"),t.on("animationcomplete",(()=>{t.destroy(),n(this.scene)}))}}let C=!1,v=0,E={};var k,D={type:Phaser.AUTO,transparent:!0,antialias:!0,scale:{mode:Phaser.Scale.FIT,parent:"game",width:720,height:1180,autoCenter:Phaser.Scale.CENTER_HORIZONTALLY},scene:[]};function _(){fetch("/api/"+localStorage.getItem("locale")+"/games/start",{method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer "+localStorage.getItem("token"),Accept:"application/json"}}).then((e=>e.json())).then((e=>{k&&k.destroy(!0),e=e.data,setTimeout((()=>{new FontFaceObserver("AVENGEANCE");k=new Phaser.Game(D);var t=P();t?(t.level!=e.levelNumber&&(V("finish"),V("score"),V("movesLeft"),V("targetCandies"),G({level:e.levelNumber})),t.movesLeft<=0&&(V("finish"),V("score"),V("movesLeft"),V("targetCandies"),G({level:e.levelNumber}))):G({level:e.levelNumber});var i=`Level${e.levelNumber}`;k.scene.add(i,new b(e.levelNumber,e)),k.scene.start(i)}),1e3)})).catch((e=>{console.error("Ошибка при получении данных:",e)}))}_();class O extends Phaser.GameObjects.Container{constructor(e,t,a,o,n,l,r,d,h,c){super(e),this.animatedElements=[];const f={fontSize:"40px",fill:"#fff",fontFamily:"Montserrat",wordWrap:{width:230,useAdvancedWrap:!0}};let m={fontSize:"28px",fill:"#fff",fontStyle:"bold",fontFamily:"AVENGEANCE",wordWrap:{width:430,useAdvancedWrap:!0}},u={fontSize:"28px",fill:"#fff",fontStyle:"bold",fontFamily:"AVENGEANCE",wordWrap:{width:430,useAdvancedWrap:!0},align:"center"},y={fontSize:"32px",fill:"#fff",fontStyle:"bold",fontFamily:"AVENGEANCE",wordWrap:{width:430,useAdvancedWrap:!0},align:"center"};const x=e.add.graphics({fillStyle:{color:"0x0F0F59",alpha:.8}});if(x.fillRect(0,0,e.cameras.main.width,e.cameras.main.height),x.setDepth(100),this.add(x),x.elementId="background",!0===n){const t=e.add.sprite(e.cameras.main.width/1.21,20,"coins_bg");t.setDepth(102),t.setOrigin(.5,0),this.add(t);const i=e.add.text(e.cameras.main.width/1.17,t.y+8,e.userCoins,f);i.setDepth(103),i.setOrigin(.5,0),i.setShadow(1,1,"rgba(0,0,0,0.4)",2),this.add(i),this.animatedElements.push(i,t)}if(!0===o){const t=e.add.sprite(100,20,"energy_bg");t.setDepth(102),t.setOrigin(.5,0),this.add(t);const i=e.add.text(120,t.y+7,e.userEnergy,f);i.setDepth(103),i.setOrigin(.5,0),i.setShadow(1,1,"rgba(0,0,0,0.4)",2),this.add(i),this.animatedElements.push(i,t)}if("start"===h)var S=e.add.sprite(e.cameras.main.width/2,200,"popup");else if("end"===h)S=e.add.sprite(e.cameras.main.width/2,105,"modal_end");else if("err"===h)S=e.add.sprite(e.cameras.main.width/2,200,"modal_err");else if("gift"===h)if("box"===e.instantGift)S=e.add.sprite(e.cameras.main.width/2,200,"modal_gift_box");else S=e.add.sprite(e.cameras.main.width/2,200,"modal_gift_mobi");if(S.elementId="container",S.setOrigin(.5,0),S.setScale(.9),S.setDepth(101),this.add(S),!0===l){const t=new g(e,0,0,e.levelData.targetCandies);t.setDepth(102),this.add(t),this.animatedElements.push(t)}if(!0===c){const t=new M(e,0,50);t.setDepth(102),this.add(t),this.animatedElements.push(t)}if(!0===a){const t=new p(e,240,"end"===h?660:640,"start"===h?e.langdata.modal_coins2:e.langdata.modal_coins,e.coinWin);t.setDepth(102),this.add(t),this.animatedElements.push(t)}if("start"===h){const t=e.add.sprite(e.cameras.main.width/1.21,160,"btnClose");t.setDepth(103),t.setOrigin(0,0),t.setInteractive(),t.on("pointerdown",(function(){window.location.href="/"+localStorage.getItem("locale")+"/profile"})),this.add(t),this.animatedElements.push(t)}else if("end"===h){const t=e.add.sprite(e.cameras.main.width/1.21,220,"btnClose");t.setDepth(103),t.setOrigin(0,0),t.setInteractive(),t.on("pointerdown",(function(){window.location.href="/"+localStorage.getItem("locale")+"/profile"})),this.add(t),this.animatedElements.push(t)}let b=e.add.text(e.cameras.main.width/2,"end"===h?300:240,t,{fontSize:"64px",fill:"#fff",fontStyle:"bold",fontFamily:"AVENGEANCE"});if(b.setOrigin(.5,0),b.setShadow(2,2,"rgba(0,0,0,0.4)",2),b.setDepth(102),this.add(b),"err"===h||"gift"===h){let t=e.add.text(e.cameras.main.width/2,"gift"===h?650:418,e.langdata.gift_text,"gift"===h?u:m);t.setDepth(102),t.setOrigin(.5,0),t.setShadow(1,1,"rgba(0,0,0,0.4)",2),this.add(t),this.animatedElements.push(t)}if("gift"===h){if("box"===e.instantGift)var w=e.add.text(e.cameras.main.width/2,740,e.langdata.gift_box,y);else w=e.add.text(e.cameras.main.width/2,740,e.langdata.gift_mobi,y);w.setDepth(102),w.setOrigin(.5,0),w.setShadow(1,1,"rgba(0,0,0,0.4)",2),this.add(w),this.animatedElements.push(w)}if(!0===r){var C=new i(e,e.cameras.main.width/2,"end"===h?810:"start"==h?820:"err"==h?620:900,d,(()=>{"start"===h?(this.hideModal(),1===e.levelNumber&&setTimeout((()=>{e.hintModal=new z(e,"modal_hint_energy",e.langdata.hint_title,e.langdata.hint_subtitle_energy,e.langdata.hint_text_energy,e.langdata.btn_end),e.hintModal.setDepth(101),e.hintModal.showModal()}),320),2===e.levelNumber&&setTimeout((()=>{e.hintModal=new z(e,"modal_hint_rocket",e.langdata.hint_title,e.langdata.hint_subtitle_rocket,e.langdata.hint_text_rocket,e.langdata.btn_end),e.hintModal.setDepth(101),e.hintModal.showModal()}),320),3===e.levelNumber&&setTimeout((()=>{e.hintModal=new z(e,"modal_hint_bomb",e.langdata.hint_title,e.langdata.hint_subtitle_bomb,e.langdata.hint_text_bomb,e.langdata.btn_end),e.hintModal.setDepth(101),e.hintModal.showModal()}),320),4===e.levelNumber&&setTimeout((()=>{e.hintModal=new z(e,"modal_hint_light",e.langdata.hint_title,e.langdata.hint_subtitle_light,e.langdata.hint_text_light,e.langdata.btn_end),e.hintModal.setDepth(101),e.hintModal.showModal()}),320)):"end"===h?(this.hideModal(),e.goToNextLevel()):"err"===h||this.hideModal()}),"normal");C.elementId="button",C.setScale(.9),C.setDepth(102),this.add(C),this.animatedElements.push(C)}if("err"===h){const t=new s(e,e.cameras.main.width/2,C.y+120,e.langdata.btn_friend,(()=>{}),"border");t.elementId="button",t.setScale(.9),t.setDepth(102),this.add(t),this.animatedElements.push(t)}this.animatedElements.push(S,b,x),this.setInteractive(new Phaser.Geom.Rectangle(0,0,e.cameras.main.width,e.cameras.main.height),Phaser.Geom.Rectangle.Contains),e.add.existing(this),this.setVisible(!1),this.setActive(!1)}showModal(){this.animatedElements.forEach((e=>{var t;t="container"===e.elementId||"button"===e.elementId?{targets:e,y:{from:-100,to:e.y},scale:{from:0,to:.9},alpha:{from:0,to:1},duration:360,ease:"Back.easeOut"}:"background"===e.elementId?{targets:e,alpha:{from:0,to:1},duration:360,ease:"Back.easeOut"}:{targets:e,y:{from:-100,to:e.y},scale:{from:0,to:1},alpha:{from:0,to:1},duration:360,ease:"Back.easeOut"},this.scene.tweens.add(t)})),this.setVisible(!0),this.setActive(!0)}hideModal(){this.animatedElements.forEach((e=>{var t;t="container"===e.elementId||"button"===e.elementId?{targets:e,y:{from:e.y,to:-100},scale:{from:.9,to:0},alpha:{from:1,to:0},duration:360,ease:"Back.easeOut",onComplete:()=>{this.setVisible(!1),this.setActive(!1)}}:"background"===e.elementId?{targets:e,alpha:{from:1,to:0},duration:360,delay:160,ease:"Cubic.easeInOut",onComplete:()=>{this.setVisible(!1),this.setActive(!1)}}:{targets:e,y:{from:e.y,to:-100},scale:{from:1,to:0},alpha:{from:1,to:0},duration:360,ease:"Back.easeOut",onComplete:()=>{this.setVisible(!1),this.setActive(!1)}},this.scene.tweens.add(t)}))}}class z extends Phaser.GameObjects.Container{constructor(e,t,s,a,o,n){super(e),this.animatedElements=[];const l=e.add.graphics({fillStyle:{color:"0x0F0F59",alpha:.8}});l.fillRect(0,0,e.cameras.main.width,e.cameras.main.height),l.setDepth(100),this.add(l),l.elementId="background";var r=e.add.sprite(e.cameras.main.width/2,105,t);r.elementId="container",r.setOrigin(.5,0),r.setScale(.9),r.setDepth(101),this.add(r);let d=e.add.text(e.cameras.main.width/2,200,s,{fontSize:"64px",fill:"#fff",fontStyle:"bold",fontFamily:"AVENGEANCE"});d.setOrigin(.5,0),d.setShadow(2,2,"rgba(0,0,0,0.4)",2),d.setDepth(102),this.add(d);var h=e.add.text(e.cameras.main.width/2,600,a,{fontSize:"40px",fill:"#fff",fontStyle:"bold",fontFamily:"AVENGEANCE",wordWrap:{width:430,useAdvancedWrap:!0},align:"center"});h.setDepth(102),h.setOrigin(.5,0),h.setShadow(1,1,"rgba(0,0,0,0.4)",2),this.add(h),this.animatedElements.push(h);let c=e.add.text(e.cameras.main.width/2,710,o,{fontSize:"26px",fill:"#fff",fontStyle:"bold",fontFamily:"AVENGEANCE",wordWrap:{width:500,useAdvancedWrap:!0},align:"center"});c.setDepth(102),c.setOrigin(.5,0),c.setShadow(1,1,"rgba(0,0,0,0.4)",2),this.add(c),this.animatedElements.push(c);var g=new i(e,e.cameras.main.width/2,920,n,(()=>{this.hideModal()}),"normal");g.elementId="button",g.setScale(.9),g.setDepth(102),this.add(g),this.animatedElements.push(g),this.animatedElements.push(r,d,l),this.setInteractive(new Phaser.Geom.Rectangle(0,0,e.cameras.main.width,e.cameras.main.height),Phaser.Geom.Rectangle.Contains),e.add.existing(this),this.setVisible(!1),this.setActive(!1)}showModal(){this.animatedElements.forEach((e=>{var t;t="container"===e.elementId||"button"===e.elementId?{targets:e,y:{from:-100,to:e.y},scale:{from:0,to:.9},alpha:{from:0,to:1},duration:360,ease:"Back.easeOut"}:"background"===e.elementId?{targets:e,alpha:{from:0,to:1},duration:360,ease:"Back.easeOut"}:{targets:e,y:{from:-100,to:e.y},scale:{from:0,to:1},alpha:{from:0,to:1},duration:360,ease:"Back.easeOut"},this.scene.tweens.add(t)})),this.setVisible(!0),this.setActive(!0)}hideModal(){this.animatedElements.forEach((e=>{var t;t="container"===e.elementId||"button"===e.elementId?{targets:e,y:{from:e.y,to:-100},scale:{from:.9,to:0},alpha:{from:1,to:0},duration:360,ease:"Back.easeOut",onComplete:()=>{this.setVisible(!1),this.setActive(!1)}}:"background"===e.elementId?{targets:e,alpha:{from:1,to:0},duration:360,delay:160,ease:"Cubic.easeInOut",onComplete:()=>{this.setVisible(!1),this.setActive(!1)}}:{targets:e,y:{from:e.y,to:-100},scale:{from:1,to:0},alpha:{from:1,to:0},duration:360,ease:"Back.easeOut",onComplete:()=>{this.setVisible(!1),this.setActive(!1)}},this.scene.tweens.add(t)}))}}class A extends Phaser.GameObjects.Container{constructor(e,t,a,o,n,l){super(e),this.animatedElements=[];const r=e.add.graphics({fillStyle:{color:"0x0F0F59",alpha:.8}});r.fillRect(0,0,e.cameras.main.width,e.cameras.main.height),r.setDepth(100),this.add(r),r.elementId="background";var d=e.add.sprite(e.cameras.main.width/2,105,t);d.elementId="container",d.setOrigin(.5,0),d.setScale(.9),d.setDepth(101),this.add(d);let h=e.add.text(e.cameras.main.width/2,150,a,{fontSize:"64px",fill:"#fff",fontStyle:"bold",fontFamily:"AVENGEANCE"});h.setOrigin(.5,0),h.setShadow(2,2,"rgba(0,0,0,0.4)",2),h.setDepth(102),this.add(h);var c=e.add.text(e.cameras.main.width/2,550,o,{fontSize:"32px",fill:"#fff",fontStyle:"bold",fontFamily:"AVENGEANCE",wordWrap:{width:530,useAdvancedWrap:!0},align:"center"});c.setDepth(102),c.setOrigin(.5,0),c.setShadow(1,1,"rgba(0,0,0,0.4)",2),this.add(c),this.animatedElements.push(c);var g=new i(e,e.cameras.main.width/2,c.y+180,l,(()=>{window.location.href="/"+localStorage.getItem("locale")+"/profile"}),"normal");g.elementId="button",g.setScale(.9),g.setDepth(102),this.add(g),this.animatedElements.push(g);const p=e.add.sprite(e.cameras.main.width/1.21,90,"btnClose");p.setDepth(103),p.setOrigin(0,0),p.setInteractive(),p.on("pointerdown",(function(){window.location.href="/"+localStorage.getItem("locale")+"/profile"})),this.add(p),this.animatedElements.push(p);const f=new s(e,e.cameras.main.width/2,g.y+120,e.langdata.btn_friend,(()=>{window.location.href="/"+localStorage.getItem("locale")+"/profile"}),"border");f.elementId="button",f.setScale(.9),f.setDepth(102),this.add(f),this.animatedElements.push(f),this.animatedElements.push(d,h,r),this.setInteractive(new Phaser.Geom.Rectangle(0,0,e.cameras.main.width,e.cameras.main.height),Phaser.Geom.Rectangle.Contains),e.add.existing(this),this.setVisible(!1),this.setActive(!1)}showModal(){this.animatedElements.forEach((e=>{var t;t="container"===e.elementId||"button"===e.elementId?{targets:e,y:{from:-100,to:e.y},scale:{from:0,to:.9},alpha:{from:0,to:1},duration:360,ease:"Back.easeOut"}:"background"===e.elementId?{targets:e,alpha:{from:0,to:1},duration:360,ease:"Back.easeOut"}:{targets:e,y:{from:-100,to:e.y},scale:{from:0,to:1},alpha:{from:0,to:1},duration:360,ease:"Back.easeOut"},this.scene.tweens.add(t)})),this.setVisible(!0),this.setActive(!0)}hideModal(){this.animatedElements.forEach((e=>{var t;t="container"===e.elementId||"button"===e.elementId?{targets:e,y:{from:e.y,to:-100},scale:{from:.9,to:0},alpha:{from:1,to:0},duration:360,ease:"Back.easeOut",onComplete:()=>{this.setVisible(!1),this.setActive(!1)}}:"background"===e.elementId?{targets:e,alpha:{from:1,to:0},duration:360,delay:160,ease:"Cubic.easeInOut",onComplete:()=>{this.setVisible(!1),this.setActive(!1)}}:{targets:e,y:{from:e.y,to:-100},scale:{from:1,to:0},alpha:{from:1,to:0},duration:360,ease:"Back.easeOut",onComplete:()=>{this.setVisible(!1),this.setActive(!1)}},this.scene.tweens.add(t)}))}}function I(e,i){const s=e.filter((e=>"bomb"===e.type)),a=e.filter((e=>"rocket"===e.type)),o=e.filter((e=>"lightning"===e.type)),r=i.offsetX;e.forEach((e=>{if("bomb"!==e.type||"rocket"!==e.type||"lightning"!==e.type){let{x:t,y:s}=e,a=i.grid[s][t];if(a){let e=i.add.sprite(t*i.СandySize+r,s*i.СandySize+i.offsetY,"explosion2").setScale(i.explosionSpriteSize);e.play("explode2"),e.on("animationcomplete",(()=>{})),l(a.sprite,(()=>{e.destroy(),n(i)})),i.grid[s][t]=null,i.score+=3,"candy5"===a.color&&Y(i,"plus"),E[a.color]&&E[a.color].collected<E[a.color].required&&E[a.color].collected++}}})),s.forEach((e=>{!function(e,i,s){const a=new t(s,e,i);a.enableSwipe(),s.grid[i][e]=a,C&&console.log(`Бомба создана в позиции (${e}, ${i})`)}(e.x,e.y,i),C&&console.log(`Бомба создана в (${e.x}, ${e.y})`)})),o.forEach((e=>{!function(e,t,i,s){const a=new w(i,e,t,s);a.enableSwipe(),i.grid[t][e]=a,C&&console.log(`Молния создана в позиции (${e}, ${t}) с цветом ${s}`)}(e.x,e.y,i),C&&console.log(`Молния создана в (${bomb.x}, ${bomb.y})`)})),a.forEach((e=>{!function(e,t,i,s){const a=new N(i,e,t,s);a.enableSwipe(),i.grid[t][e]=a,C&&console.log(`Ракета ${s} создана в позиции (${e}, ${t})`)}(e.x,e.y,i,e.direction),C&&console.log(`Ракета создана в (${e.x}, ${e.y}) ${e.direction}`)})),X(i),S(i),R(i)}class N extends e{constructor(e,t,i,s){super(e,t,i,"rocket"),this.rocketType=s,this.createCandySprite()}createCandySprite(){super.createCandySprite(),this.sprite.setTexture("rocket"),this.sprite.setScale(.1),"horizontal"===this.rocketType&&this.sprite.setRotation(Math.PI/2),this.scene.tweens.add({targets:this.sprite,scaleX:this.scene.СandySpriteSize,scaleY:this.scene.СandySpriteSize,ease:"Back.easeOut",duration:500,delay:300})}explodeCrossRocket(){if(this.hasExploded)return;this.hasExploded=!0;const e=40;for(let t=0;t<this.gridWidth;t++)this.x-t>=0&&this.scene.time.delayedCall(e*t,(()=>{this.checkAndExplodeSpecialCandy(this.y,this.x-t)})),this.x+t<this.gridWidth&&this.scene.time.delayedCall(e*t,(()=>{this.checkAndExplodeSpecialCandy(this.y,this.x+t)}));for(let t=0;t<this.gridHeight;t++)this.y-t>=0&&this.scene.time.delayedCall(e*t,(()=>{this.checkAndExplodeSpecialCandy(this.y-t,this.x)})),this.y+t<this.gridHeight&&this.scene.time.delayedCall(e*t,(()=>{this.checkAndExplodeSpecialCandy(this.y+t,this.x)}));this.scene.time.delayedCall(e*Math.max(this.gridWidth,this.gridHeight),(()=>{this.checkAndExplodeSpecialCandy(this.y,this.x)})),this.scene.time.delayedCall(e*(this.gridWidth+this.gridHeight),(()=>{n(this.scene)}))}explodeRocket(){if(this.hasExploded)return;this.hasExploded=!0;if(this.scene.score+=100,"horizontal"===this.rocketType)for(let e=0;e<this.gridHeight;e++)this.y-e>=0&&this.scene.time.delayedCall(80*e,(()=>{this.checkAndExplodeSpecialCandy(this.y-e,this.x)})),this.y+e<this.gridHeight&&this.scene.time.delayedCall(80*e,(()=>{this.checkAndExplodeSpecialCandy(this.y+e,this.x)}));else if("vertical"===this.rocketType)for(let e=0;e<this.gridWidth;e++)this.x-e>=0&&this.scene.time.delayedCall(80*e,(()=>{this.checkAndExplodeSpecialCandy(this.y,this.x-e)})),this.x+e<this.gridWidth&&this.scene.time.delayedCall(80*e,(()=>{this.checkAndExplodeSpecialCandy(this.y,this.x+e)}));S(this.scene),R(this.scene),this.scene.time.delayedCall(80*Math.max(this.gridWidth,this.gridHeight),(()=>{n(this.scene)}))}checkAndExplodeSpecialCandy(e,i){let s=this.grid[e][i];if(s){let a=this.scene.add.sprite(s.sprite.x,s.sprite.y,"explosion2").setScale(this.scene.explosionSpriteSize);if(a.setDepth(10),a.play("explode2"),a.on("animationcomplete",(()=>{a.destroy()})),s instanceof u)return void y(i,e,this.scene.levelData,this.scene.grid);"candy5"===s.color&&Y(this.scene,"plus"),l(s.sprite,(()=>{this.scene.score+=15,E[s.color]&&E[s.color].collected<E[s.color].required&&E[s.color].collected++})),s instanceof t?s.explodeBomb():s instanceof N&&"function"==typeof s.explodeRocket&&s.explodeRocket(),this.grid[e][i]=null}}}class M extends Phaser.GameObjects.Container{constructor(e,t,i){super(e,t,i);let s={score:0};P();let a=e.add.text(e.cameras.main.width/2,418,e.langdata.modal_score,{fontSize:"28px",fill:"#fff",fontStyle:"bold",fontFamily:"AVENGEANCE"});a.setDepth(102),a.setOrigin(.5,0),a.setShadow(1,1,"rgba(0,0,0,0.4)",2),this.add(a);let o=e.add.text(e.cameras.main.width/2,a.y+40,0,{fontSize:"100px",fill:"#fff",fontStyle:"bold",fontFamily:"AVENGEANCE"});o.setDepth(102),o.setOrigin(.5,0),o.setShadow(1,1,"rgba(0,0,0,0.4)",2),this.add(o),e.tweens.add({targets:s,score:e.coinWin,duration:1e3,delay:260,ease:"Sine.easeInOut",onUpdate:function(){o.setText(Math.round(s.score).toString())}}),this.scene.add.existing(this)}updateScore(e){this.scene.tweens.add({targets:this.scoreAnim,score:e,duration:1e3,delay:260,ease:"Sine.easeInOut",onUpdate:function(){score.setText(Math.round(scoreAnim.score).toString())}})}}function T(e,t,i){const s=e.levelData.tiles.length,a=e.levelData.tiles[0].length;let o=e.grid;if(C&&console.log(`Проверка свайпа для координат (${t}, ${i})`),t<0||t>=a||i<0||i>=s||!o[i][t])return console.log("Конфета вне сетки или не существует"),!1;if(o[i][t].isFrozen)return C&&console.log("Конфета заморожена"),!1;const n=o[i][t].color;if(console.log(`Цвет текущей конфеты: ${n}`),t>0){if(C&&console.log("Проверка свайпа влево"),t<a-2&&o[i][t+1]&&o[i][t+2]&&!o[i][t+1].isFrozen&&!o[i][t+2].isFrozen&&o[i][t+1].color===n&&o[i][t+2].color===n)return C&&console.log("Две конфеты справа"),{swipedCandyX:t-1,swipedCandyY:i};if(t<a-3&&o[i][t+1]&&o[i][t+3]&&!o[i][t+1].isFrozen&&!o[i][t+3].isFrozen&&o[i][t+1].color===n&&o[i][t+3].color===n)return C&&console.log("Одна конфета справа и одна через позицию"),{swipedCandyX:t-1,swipedCandyY:i};if(t>1&&o[i][t-2]&&o[i][t+1]&&!o[i][t-2].isFrozen&&!o[i][t+1].isFrozen&&o[i][t-2].color===n&&o[i][t+1].color===n)return C&&console.log("Одна конфета слева и одна через позицию справа"),{swipedCandyX:t-2,swipedCandyY:i};if(i>1&&o[i-2][t]&&o[i+1][t]&&!o[i-2][t].isFrozen&&!o[i+1][t].isFrozen&&o[i-2][t].color===n&&o[i+1][t].color===n)return console.log("Одна конфета сверху и одна через позицию снизу"),{swipedCandyX:t-1,swipedCandyY:i-2};if(i>1&&o[i-1][t-1]&&o[i-2][t-1]&&o[i-1][t-1].color===n&&o[i-2][t-1].color===n)return console.log("Две одноцветные конфеты сверху"),{swipedCandyX:t,swipedCandyY:i};if(i<s-2&&o[i+1][t-1]&&o[i+2][t-1]&&o[i+1][t-1].color===n&&o[i+2][t-1].color===n)return console.log("Две одноцветные конфеты снизу"),{swipedCandyX:t,swipedCandyY:i}}if(t<a-1){if(console.log("Проверка свайпа вправо"),t>1&&o[i][t-1]&&o[i][t-2]&&o[i][t-1].color===n&&o[i][t-2].color===n)return console.log("Проверка свайпа вправо"),{swipedCandyX:t,swipedCandyY:i};if(t>2&&o[i][t-1]&&o[i][t-3]&&o[i][t-1].color===n&&o[i][t-3].color===n)return console.log("Одна конфета слева и одна через позицию"),{swipedCandyX:t,swipedCandyY:i};if(t<a-2&&o[i][t+2]&&o[i][t-1]&&o[i][t+2].color===n&&o[i][t-1].color===n)return console.log("Одна конфета справа и одна через позицию слева"),{swipedCandyX:t,swipedCandyY:i};if(i>1&&o[i-1][t+1]&&o[i-2][t+1]&&o[i-1][t+1].color===n&&o[i-2][t+1].color===n)return console.log("Две одноцветные конфеты сверху"),{swipedCandyX:t,swipedCandyY:i};if(i<s-2&&o[i+1][t+1]&&o[i+2][t+1]&&o[i+1][t+1].color===n&&o[i+2][t+1].color===n)return console.log("Две одноцветные конфеты снизу"),{swipedCandyX:t,swipedCandyY:i}}if(i>0){if(console.log("Проверка свайпа вверх"),i<s-2&&o[i+1][t]&&o[i+2][t]&&o[i+1][t].color===n&&o[i+2][t].color===n)return console.log("Две конфеты снизу"),{swipedCandyX:t,swipedCandyY:i};if(i<s-3&&o[i+1][t]&&o[i+3][t]&&o[i+1][t].color===n&&o[i+3][t].color===n)return console.log("Одна конфета снизу и одна через позицию"),{swipedCandyX:t,swipedCandyY:i};if(i>1&&o[i-2][t]&&o[i+1][t]&&o[i-2][t].color===n&&o[i+1][t].color===n)return console.log("Одна конфета сверху и одна через позицию снизу"),{swipedCandyX:t,swipedCandyY:i-2};if(t>1&&o[i-1][t-1]&&o[i-1][t-2]&&o[i-1][t-1].color===n&&o[i-1][t-2].color===n)return console.log("Две одноцветные конфеты слева"),{swipedCandyX:t,swipedCandyY:i};if(t<a-2&&o[i-1][t+1]&&o[i-1][t+2]&&o[i-1][t+1].color===n&&o[i-1][t+2].color===n)return console.log("Две одноцветные конфеты справа"),{swipedCandyX:t,swipedCandyY:i}}if(i<s-1){if(console.log("Проверка свайпа вниз"),i>1&&o[i-1][t]&&o[i-2][t]&&o[i-1][t].color===n&&o[i-2][t].color===n)return console.log("Две конфеты сверху"),{swipedCandyX:t,swipedCandyY:i};if(i>2&&o[i-1][t]&&o[i-3][t]&&o[i-1][t].color===n&&o[i-3][t].color===n)return console.log("Одна конфета сверху и одна через позицию"),{swipedCandyX:t,swipedCandyY:i};if(i>0&&i<s-2&&o[i+2][t]&&o[i-1][t]&&o[i+2][t].color===n&&o[i-1][t].color===n)return console.log("Одна конфета снизу и одна через позицию сверху"),{swipedCandyX:t,swipedCandyY:i-2};if(t>1&&o[i+1][t-1]&&o[i+1][t-2]&&o[i+1][t-1].color===n&&o[i+1][t-2].color===n)return console.log("Две одноцветные конфеты слева"),{swipedCandyX:t,swipedCandyY:i};if(t<a-2&&o[i+1][t+1]&&o[i+1][t+2]&&o[i+1][t+1].color===n&&o[i+1][t+2].color===n)return console.log("Две одноцветные конфеты справа"),{swipedCandyX:t,swipedCandyY:i}}return console.log("Нет подходящих свайпов"),!1}function F(){"0"!=scene.levelData.timeLeft&&(scene.levelData.timeLeft--,this.timeText.setText("Время: "+scene.levelData.timeLeft),scene.levelData.timeLeft<=0&&(this.timeEvent.remove(),alert("Время вышло")))}var W="WsF0fym40tdWZcMX22Au1LvSdEkHfNUB";function X(e){let t=e.score;e.tweens.add({targets:{value:e.currentScore},value:t,duration:500,ease:"Sine.easeInOut",onUpdate:function(t){const i=Math.round(t.getValue());e.scoreText.setText(i)},onComplete:function(){e.currentScore=t}}),G({score:t})}function G(e){var t=localStorage.getItem("localeData");null!==t&&(t=(t=CryptoJS.AES.decrypt(t,W)).toString(CryptoJS.enc.Utf8));var i=t?JSON.parse(t):{};for(var s in e)i[s]=e[s];const a=JSON.stringify(i),o=CryptoJS.AES.encrypt(a,W).toString();localStorage.setItem("localeData",o)}function P(){const e=localStorage.getItem("localeData");if(!e)return null;try{const t=CryptoJS.AES.decrypt(e,W).toString(CryptoJS.enc.Utf8);return JSON.parse(t)}catch(e){return console.error("Не удалось расшифровать данные:",e),null}}function Y(e,t){"plus"===t?e.levelData.movesLeft++:e.levelData.movesLeft--,e.movesText.setText(e.levelData.movesLeft),G({movesLeft:e.levelData.movesLeft}),e.levelData.movesLeft<0&&(alert("Закончились ходы!"),setTimeout((()=>{window.location.href="/game"}),300))}function V(e){var t=localStorage.getItem("localeData");null!==t&&(t=(t=CryptoJS.AES.decrypt(t,W)).toString(CryptoJS.enc.Utf8));var i=t?JSON.parse(t):{};if(i.hasOwnProperty(e)){delete i[e];const t=JSON.stringify(i),s=CryptoJS.AES.encrypt(t,W).toString();localStorage.setItem("localeData",s)}}function R(e){let t=!0;for(let e in E)if(E[e].collected<E[e].required){t=!1;break}if(t&&0===v){G({finish:!0});var i={userId:e.userId,level:e.levelNumber,score:e.score,time:0,finish:!0};s=i,fetch("/api/"+localStorage.getItem("locale")+"/games/finish",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+localStorage.getItem("token"),Accept:"application/json"},body:JSON.stringify(s)}).then((e=>e.json())).then((e=>{console.log(e)})).catch((e=>{console.error("Ошибка при отправке данных:",e)})),e.levelData.userCoins+=e.coinWin,e.levelData.userEnergy--,setTimeout((()=>{(e.endModal.showModal(),1==P().finish)||G({level:e.levelNumber+1})}),300)}var s}})();